{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/autosaver\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author kuldeep singh <mca.kuldeep.sekhon@gmail.com>\n */\n\nimport { call } from 'core/ajax';\nimport { create } from 'core/modal_factory';\nimport { get_string as getString } from 'core/str';\nimport { save, cancel, hidden } from 'core/modal_events';\nimport user from 'tiny_cursive/user';\n\nexport const register = (editor) => {\n\n    var is_student, intervention, quizSubmit, assignSubmit;\n    document.addEventListener('DOMContentLoaded', function () {\n\n        quizSubmit = document.querySelector('#mod_quiz-next-nav');\n        assignSubmit = document.querySelector('#id_submitbutton');\n\n        assignSubmit.addEventListener('click', clickHandler.assign_submit_button);\n        quizSubmit.addEventListener('click', clickHandler.quiz_submit_button);\n\n        var bodyElement = document.querySelector('#body');\n        if (bodyElement) {\n            is_student = !bodyElement.classList.contains('teacher_admin'); // true or false\n            intervention = bodyElement.classList.contains('intervention'); // true or false\n        } else {\n            console.error('#body element not found');\n        }\n    });\n\n    var userid = null;\n    var host = null;\n    var courseid = null;\n    var filename = \"\";\n    var ed = \"\";\n    var event = \"\";\n    var recourceId = 0;\n    var modulename = \"\";\n    var editorid = editor?.id;\n    let classes = document.body.className.split(' ');\n    var cmid = 0;\n    var questionid = 0;\n    var syncInterval = 10000; // Sync Every 10s.\n\n    const postOne = async (methodname, args) => {\n        try {\n            const response = await call([{\n                methodname,\n                args,\n            }])[0];\n            return response;\n        } catch (error) {\n            console.error('Error in postOne:', error);\n            throw error;\n        }\n    };\n\n    // Common async handler function\n    const handleClick = async (e, element) => {\n        e.preventDefault();\n        if (filename) {\n            try {\n                const res = await SyncData();\n                console.log(res);\n                // Remove event listener, then trigger a click\n                element.removeEventListener('click', clickHandler[element.id]);\n                element.click();\n            } catch (error) {\n                console.error('Error in SyncData:', error);\n            }\n        } else {\n            // Remove event listener, then trigger a click\n            element.removeEventListener('click', clickHandler[element.id]);\n            element.click();\n        }\n    };\n\n    const clickHandler = {\n        assign_submit_button: (e) => handleClick(e, assignSubmit),\n        quiz_submit_button: (e) => handleClick(e, quizSubmit)\n    };\n\n    \n    const getModal = (e) => {\n        return create({\n            type: 'SAVE_CANCEL',\n            title: getString('tiny_cursive', 'tiny_cursive'),\n            body: '<textarea  class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"sourceurl\"></textarea>',\n\n            removeOnClose: true,\n        })\n            .done(modal => {\n                modal.getRoot().append('<style>.close{ display: none ! important; }</style>');\n                modal.show();\n                var lastEvent = '';\n                modal.getRoot().on(save, function () {\n                    var number = document.getElementById(\"inputUrl\").value;\n                    if (number === \"\" || number === null || number === undefined) {\n                        editor.execCommand('Undo');\n                        alert(\"You cannot paste text without providing source\");\n                    } else {\n                        editor.execCommand('Paste');\n                    }\n                    let ur = e.srcElement.baseURI;\n                    let recourceId = 0;\n                    let parm = new URL(ur);\n                    let modulename = \"\";\n                    let editorid = editor?.id;\n                    let classes = document.body.className.split(' ');\n                    let courseid = parseInt(classes.find((classname) => { return classname.startsWith('course-') }).split('-')[1]); // Getting cmid from body classlist.\n                    let cmid = parseInt(classes.find((classname) => { return classname.startsWith('cmid-') }).split('-')[1]); // Getting cmid from body classlist.\n\n\n                    if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) { } else {\n                        return false;\n                    }\n\n                    if (!ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n                        recourceId = parm.searchParams.get('attempt');\n                    }\n\n                    if (recourceId === null) {\n                        recourceId = 0;\n                    }\n                    if (ur.includes(\"forum\")) {\n                        modulename = \"forum\";\n                    }\n                    if (ur.includes(\"assign\")) {\n                        modulename = \"assign\";\n                    }\n                    if (ur.includes(\"attempt\")) {\n                        modulename = \"quiz\";\n                    }\n                    if (cmid === null) { cmid = 0; }\n\n                    postOne('cursive_user_comments', {\n                        modulename: modulename,\n                        cmid: cmid,\n                        resourceid: recourceId,\n                        courseid: courseid,\n                        usercomment: number,\n                        timemodified: \"1121232\",\n                        editorid: editorid ? editorid : \"\"\n                    });\n                    lastEvent = 'save';\n                    modal.destroy();\n                });\n                modal.getRoot().on(cancel, function () {\n\n                    editor.execCommand('Undo');\n                    lastEvent = 'cancel';\n                });\n                modal.getRoot().on(hidden, function () {\n                    if (lastEvent != 'cancel' && lastEvent != 'save') { editor.execCommand('Undo'); }\n                });\n                return modal;\n            });\n    };\n    const sendKeyEvent = (event, ed) => {\n        let ur = ed.srcElement.baseURI;\n        let parm = new URL(ur);\n        ed = ed;\n        event = event;\n        let bodyid = document.querySelector('body').id;\n\n        if (bodyid == 'page-mod-quiz-attempt' || bodyid == 'page-mod-quiz-summary' || bodyid == 'page-mod-assign-editsubmission' || bodyid == 'page-mod-forum-view' || bodyid == 'page-mod-forum-post') {\n            cmid = parseInt(classes.find((classname) => { return classname.startsWith('cmid-') }).split('-')[1]); // Getting cmid from body classlist.\n        }\n\n        if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) { } else {\n            return false;\n        }\n        if (ur.includes(\"forum\") || ur.includes(\"assign\")) {\n\n        } else {\n\n            recourceId = parm.searchParams.get('attempt');\n        }\n        if (recourceId === null) {\n\n            recourceId = 0;\n        }\n\n        if (ur.includes(\"forum\")) {\n            modulename = \"forum\";\n        }\n        if (ur.includes(\"assign\")) {\n            modulename = \"assign\";\n        }\n        if (ur.includes(\"attempt\")) {\n            modulename = \"quiz\";\n        }\n        // console.log(courseid,userid,host);\n        filename = `${userid}_${recourceId}_${cmid}_${modulename}_attempt`;\n        // console.log(filename);\n        if (modulename === 'quiz') {\n            questionid = editorid.split(':')[1].split('_')[0];\n            filename = `${userid}_${recourceId}_${cmid}_${questionid}_${modulename}_attempt`;\n            // console.log(editorid);\n        }\n        // console.log(filename,cmid,classes);\n        if (localStorage.getItem(filename)) {\n\n            let data = JSON.parse(localStorage.getItem(filename));\n            data.push({\n                resourceId: recourceId,\n                key: ed.key,\n                keyCode: ed.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid\n            });\n            localStorage.setItem(filename, JSON.stringify(data));\n        } else {\n            let data = [];\n            data.push({\n                resourceId: recourceId,\n                key: ed.key,\n                keyCode: ed.keyCode,\n                event: event,\n                courseId: courseid,\n                unixTimestamp: Date.now(),\n                clientId: host,\n                personId: userid\n            });\n            localStorage.setItem(filename, JSON.stringify(data));\n        }\n\n        // postOne('cursive_json', {\n        //     key: ed.key,\n        //     event: event,\n        //     keyCode: ed.keyCode,\n        //     resourceId: recourceId,\n        //     cmid: cmid,\n        //     modulename: modulename,\n        //     editorid: editorid ? editorid : \"\"\n        // });\n    };\n    editor.on('keyUp', (editor) => {\n        sendKeyEvent(\"keyUp\", editor);\n    });\n    editor.on('Paste', async (e) => {\n        if (is_student && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('Redo', async (e) => {\n        if (is_student && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('keyDown', (editor) => {\n        sendKeyEvent(\"keyDown\", editor);\n    });\n    editor.on('init', () => {\n        let userdata = user.getUserId();\n        userid = userdata.userid;\n        host = userdata.host;\n        courseid = userdata.courseid;\n    });\n\n    async function SyncData() {\n\n        let data = localStorage.getItem(filename);\n\n        if (!data || data.length === 0) {\n            return;\n        } else {\n            localStorage.removeItem(filename);\n            try {\n                return await postOne('cursive_write_local_to_json', {\n                    key: ed.key,\n                    event: event,\n                    keyCode: ed.keyCode,\n                    resourceId: recourceId,\n                    cmid: cmid,\n                    modulename: modulename,\n                    editorid: editorid,\n                    json_data: data,\n                });\n            } catch (error) {\n                console.error('Error submitting data:', error);\n            }\n        }\n    }\n\n    window.addEventListener('unload', (e) => {\n        SyncData();\n    });\n\n    setInterval(SyncData, syncInterval);\n};\n"],"names":["editor","is_student","intervention","quizSubmit","assignSubmit","document","addEventListener","querySelector","clickHandler","assign_submit_button","quiz_submit_button","bodyElement","classList","contains","console","error","userid","host","courseid","filename","recourceId","modulename","editorid","id","classes","body","className","split","cmid","questionid","postOne","async","methodname","args","handleClick","e","element","preventDefault","res","SyncData","log","removeEventListener","click","getModal","type","title","removeOnClose","done","modal","getRoot","append","show","lastEvent","on","save","number","getElementById","value","execCommand","alert","ur","srcElement","baseURI","parm","URL","parseInt","find","classname","startsWith","includes","searchParams","get","resourceid","usercomment","timemodified","destroy","cancel","hidden","sendKeyEvent","event","ed","bodyid","localStorage","getItem","data","JSON","parse","push","resourceId","key","keyCode","courseId","unixTimestamp","Date","now","clientId","personId","setItem","stringify","length","removeItem","json_data","userdata","user","getUserId","window","setInterval"],"mappings":"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"}