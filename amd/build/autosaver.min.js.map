{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/autosaver\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author kuldeep singh <mca.kuldeep.sekhon@gmail.com>\n */\n\nimport { call } from 'core/ajax';\nimport { create } from 'core/modal_factory';\nimport { get_string as getString } from 'core/str';\nimport { save, cancel, hidden } from 'core/modal_events';\n\nexport const register = (editor) => {\n    const postOne = (methodname, args) => call([{\n        methodname,\n        args,\n    }])[0];\n    var is_student, intervention;\n\n    var bodyElement = document.querySelector('#body');\n    if (bodyElement) {\n        is_student = !bodyElement.classList.contains('teacher_admin'); // true or false\n        intervention = bodyElement.classList.contains('intervention'); // true or false\n    } else {\n        console.error('#body element not found');\n    }\n\n    const getModal = (e) => {\n        return create({\n            type: 'SAVE_CANCEL',\n            title: getString('tiny_cursive', 'tiny_cursive'),\n            body: '<textarea class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"sourceurl\"></textarea>',\n            removeOnClose: true,\n        })\n            .done(modal => {\n                modal.getRoot().append('<style>.close { display: none !important; }</style>');\n                modal.show();\n\n                var lastEvent = '';\n                modal.getRoot().on(save, function () {\n                    var number = document.getElementById(\"inputUrl\").value;\n                    if (number === \"\" || number === null || number === undefined) {\n                        editor.execCommand('Undo');\n                        alert(\"You cannot paste text without providing source\");\n                    } else {\n                        editor.execCommand('Paste');\n                    }\n\n                    let ur = e.srcElement.baseURI;\n                    let recourceId = 0;\n                    let parm = new URL(ur);\n                    let modulename = \"\";\n                    let editorid = editor?.id;\n                    let bodyClasses = document.body.className.split(' ');\n\n                    let courseid = parseInt(bodyClasses.find(classname => classname.startsWith('course-')).split('-')[1]);\n                    let cmid = parseInt(bodyClasses.find(classname => classname.startsWith('cmid-')).split('-')[1]);\n\n                    if (!ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n                        recourceId = parm.searchParams.get('attempt');\n                    }\n\n                    recourceId = recourceId === null ? 0 : recourceId;\n\n                    if (ur.includes(\"forum\")) {\n                        modulename = \"forum\";\n                    } else if (ur.includes(\"assign\")) {\n                        modulename = \"assign\";\n                    } else if (ur.includes(\"attempt\")) {\n                        modulename = \"quiz\";\n                    }\n\n                    postOne('cursive_user_comments', {\n                        modulename: modulename,\n                        cmid: cmid || 0,\n                        resourceid: recourceId,\n                        courseid: courseid,\n                        usercomment: number,\n                        timemodified: \"1121232\",\n                        editorid: editorid || \"\"\n                    });\n\n                    lastEvent = 'save';\n                    modal.destroy();\n                });\n\n                modal.getRoot().on(cancel, function () {\n                    editor.execCommand('Undo');\n                    lastEvent = 'cancel';\n                });\n\n                modal.getRoot().on(hidden, function () {\n                    if (lastEvent !== 'cancel' && lastEvent !== 'save') {\n                        editor.execCommand('Undo');\n                    }\n                });\n\n                return modal;\n            });\n    };\n\n    const sendKeyEvent = (event, ed) => {\n        let ur = ed.srcElement.baseURI;\n        let parm = new URL(ur);\n        let recourceId = 0;\n        let modulename = \"\";\n        let editorid = editor?.id;\n        let bodyClasses = document.body.className.split(' ');\n\n        let cmid = parseInt(bodyClasses.find(classname => classname.startsWith('cmid-')).split('-')[1]);\n\n        if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) {\n            if (!ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n                recourceId = parm.searchParams.get('attempt');\n            }\n\n            recourceId = recourceId === null ? 0 : recourceId;\n\n            if (ur.includes(\"forum\")) {\n                modulename = \"forum\";\n            } else if (ur.includes(\"assign\")) {\n                modulename = \"assign\";\n            } else if (ur.includes(\"attempt\")) {\n                modulename = \"quiz\";\n            }\n\n            postOne('cursive_json', {\n                key: ed.key,\n                event: event,\n                keyCode: ed.keyCode,\n                resourceId: recourceId,\n                cmid: cmid,\n                modulename: modulename,\n                editorid: editorid || \"\"\n            });\n        }\n    };\n\n    editor.on('keyUp', (editor) => {\n        sendKeyEvent(\"keyUp\", editor);\n    });\n\n    editor.on('Paste', async (e) => {\n        if (is_student && intervention) {\n            getModal(e);\n        }\n    });\n\n    editor.on('Redo', async (e) => {\n        if (is_student && intervention) {\n            getModal(e);\n        }\n    });\n\n    editor.on('keyDown', (editor) => {\n        sendKeyEvent(\"keyDown\", editor);\n    });\n\n    editor.on('init', () => { });\n};\n"],"names":["editor","postOne","methodname","args","is_student","intervention","bodyElement","document","querySelector","classList","contains","console","error","getModal","e","type","title","body","removeOnClose","done","modal","getRoot","append","show","lastEvent","on","save","number","getElementById","value","execCommand","alert","ur","srcElement","baseURI","recourceId","parm","URL","modulename","editorid","id","bodyClasses","className","split","courseid","parseInt","find","classname","startsWith","cmid","includes","searchParams","get","resourceid","usercomment","timemodified","destroy","cancel","hidden","sendKeyEvent","event","ed","key","keyCode","resourceId","async"],"mappings":"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"}