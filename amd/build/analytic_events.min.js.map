{"version":3,"file":"analytic_events.min.js","sources":["../src/analytic_events.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module analytic_events\n *\n * @module     tiny_cursive/analytic_events\n * @copyright  2024 CTI <your@email.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport MyModal from \"./analytic_modal\";\nimport { call as getContent } from \"core/ajax\";\nimport $ from 'jquery';\nimport * as Str from 'core/str';\nimport ModalFactory from 'core/modal_factory';\n\nexport default class AnalyticEvents {\n\n    createModal(userid, context, questionid = '', authIcon) {\n        $('#analytics' + userid + questionid).on('click', function (e) {\n            e.preventDefault();\n            ModalFactory.create({ type: MyModal.TYPE, templateContext: context }).then(modal => {\n\n                modal.show();\n                const targetElement = $('#content' + userid + ' .table tbody tr:first-child td:nth-child(2)');\n                if (targetElement.length > 0) {\n                    targetElement.html(authIcon);\n                } else {\n                    console.error('Target element not found');\n                }\n            }).catch(error => {\n                console.error(\"Failed to create modal:\", error);\n            });\n        });\n    }\n\n    analytics(userid, templates, context, questionid = '', replayInstances = null, authIcon) {\n        $('body').on('click', '#analytic' + userid + questionid, function (e) {\n            $('#rep' + userid + questionid).prop('disabled', false);\n            e.preventDefault();\n            $('#content' + userid).html($('<div>').addClass('d-flex justify-content-center my-5')\n                .append($('<div>').addClass('tiny_cursive-loader')));\n            if (replayInstances && replayInstances[userid]) {\n                replayInstances[userid].stopReplay();\n            }\n            $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n            $(this).addClass('active'); // Add 'active' class to the clicked element\n\n            templates.render('tiny_cursive/analytics_table', context).then(function (html) {\n                $('#content' + userid).html(html);\n                $('#content' + userid + ' .table tbody tr:first-child td:nth-child(2)').html(authIcon);\n\n            }).fail(function (error) {\n                console.error(\"Failed to render template:\", error);\n            });\n        });\n    }\n\n    checkDiff(userid, fileid, questionid = '', replayInstances = null) {\n        const nodata = document.createElement('p');\n        nodata.classList.add('text-center', 'p-5', 'bg-light', 'rounded', 'm-5', 'text-primary');\n        nodata.style.verticalAlign = 'middle';\n        nodata.style.textTransform = 'uppercase';\n        nodata.style.fontWeight = '500';\n        nodata.textContent = \"no data received yet\";\n\n        $('body').on('click', '#diff' + userid + questionid, function (e) {\n            $('#rep' + userid + questionid).prop('disabled', false);\n            e.preventDefault();\n            $('#content' + userid).html($('<div>').addClass('d-flex justify-content-center my-5')\n                .append($('<div>').addClass('tiny_cursive-loader')));\n            $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n            $(this).addClass('active'); // Add 'active' class to the clicked element\n            if (replayInstances && replayInstances[userid]) {\n                replayInstances[userid].stopReplay();\n            }\n            if (!fileid) {\n                $('#content' + userid).html(nodata);\n                throw new Error('Missing file id or Difference Content not received yet');\n            }\n            getContent([{\n                methodname: 'cursive_get_writing_differences',\n                args: { fileid: fileid },\n            }])[0].done(response => {\n                let responsedata = JSON.parse(response.data);\n                if (responsedata[0]) {\n                    let submitted_text = atob(responsedata[0].submitted_text);\n\n                    // Fetch the dynamic strings\n                    Str.get_strings([\n                        {key: 'originaltext', component: 'tiny_cursive'},\n                        {key: 'editspastesai', component: 'tiny_cursive'}\n                    ]).done(strings => {\n                        const originalTextString = strings[0];\n                        const editsPastesAIString = strings[1];\n\n                        const $legend = $('<div class=\"d-flex p-2 border rounded mb-2\">');\n\n                        // Create the first legend item\n                        const $attributedItem = $('<div>', { class: 'tiny_cursive-legend-item' });\n                        const $attributedBox = $('<div>', { class: 'tiny_cursive-box attributed' });\n                        const $attributedText = $('<span>').text(originalTextString);\n                        $attributedItem.append($attributedBox).append($attributedText);\n\n                        // Create the second legend item\n                        const $unattributedItem = $('<div>', { class: 'tiny_cursive-legend-item' });\n                        const $unattributedBox = $('<div>', { class: 'tiny_cursive-box tiny_cursive_added' });\n                        const $unattributedText = $('<span>').text(editsPastesAIString);\n                        $unattributedItem.append($unattributedBox).append($unattributedText);\n\n                        // Append the legend items to the legend container\n                        $legend.append($attributedItem).append($unattributedItem);\n\n                        let contents = $('<div>').addClass('tiny_cursive-comparison-content');\n                        let textBlock2 = $('<div>').addClass('tiny_cursive-text-block').append(\n                            $('<div>').attr('id', 'tiny_cursive-reconstructed_text').html(JSON.parse(submitted_text))\n                        );\n\n                        contents.append($legend, textBlock2);\n                        $('#content' + userid).html(contents); // Update content\n                    }).fail(error => {\n                        console.error(\"Failed to load language strings:\", error);\n                        $('#content' + userid).html(nodata);\n                    });\n                } else {\n                    $('#content' + userid).html(nodata);\n                }\n            }).fail(error => {\n                $('#content' + userid).html(nodata);\n                throw new Error('Error loading JSON file: ' + error.message);\n            });\n        });\n    }\n\n    replyWriting(userid, filepath, questionid = '', replayInstances = null) {\n        $('body').on('click', '#rep' + userid + questionid, function (e) {\n            $(this).prop('disabled', true);\n            e.preventDefault();\n            $('#content' + userid).html($('<div>').addClass('d-flex justify-content-center my-5')\n                .append($('<div>').addClass('tiny_cursive-loader')));\n            $('.tiny_cursive-nav-tab').find('.active').removeClass('active');\n            $(this).addClass('active'); // Add 'active' class to the clicked element\n            if (replayInstances && replayInstances[userid]) {\n                replayInstances[userid].stopReplay();\n            }\n            if (questionid) {\n                video_playback(userid, filepath, questionid);\n            } else {\n                video_playback(userid, filepath);\n            }\n        });\n    }\n\n    formatedTime(data) {\n        if (data.total_time_seconds) {\n            let total_time_seconds = data.total_time_seconds;\n            let hours = Math.floor(total_time_seconds / 3600).toString().padStart(2, 0);\n            let minutes = Math.floor((total_time_seconds % 3600) / 60).toString().padStart(2, 0);\n            let seconds = (total_time_seconds % 60).toString().padStart(2, 0);\n            return `${hours}h ${minutes}m ${seconds}s`;\n        } else {\n            return \"0h 0m 0s\";\n        }\n    }\n\n    authorshipStatus(firstFile, score, score_setting) {\n        var icon = 'fa fa-circle-o';\n        var color = 'font-size:32px;color:black';\n        var score = parseFloat(score);\n\n        if (firstFile) {\n            icon = 'fa fa-solid fa-info-circle';\n            color = 'font-size:32px;color:#000000';\n        } else if (score >= score_setting) {\n            icon = 'fa fa-check-circle';\n            color = 'font-size:32px;color:green';\n        } else if (score < score_setting) {\n            icon = 'fa fa-question-circle';\n            color = 'font-size:32px;color:#A9A9A9';\n        }\n\n        return $('<i>').addClass(icon).attr('style', color);\n    }\n}\n"],"names":["_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","_interopRequireDefault","obj","__esModule","default","_analytic_modal","_jquery","Str","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","_interopRequireWildcard","_modal_factory","_exports","createModal","userid","context","questionid","arguments","length","undefined","authIcon","$","on","e","preventDefault","ModalFactory","create","type","MyModal","TYPE","templateContext","then","modal","show","targetElement","html","console","error","catch","analytics","templates","replayInstances","prop","addClass","append","stopReplay","find","removeClass","this","render","fail","checkDiff","fileid","nodata","document","createElement","classList","add","style","verticalAlign","textTransform","fontWeight","textContent","Error","getContent","methodname","args","done","response","responsedata","JSON","parse","data","submitted_text","atob","get_strings","component","strings","originalTextString","editsPastesAIString","$legend","$attributedItem","class","$attributedBox","$attributedText","text","$unattributedItem","$unattributedBox","$unattributedText","contents","textBlock2","attr","message","replyWriting","filepath","video_playback","formatedTime","total_time_seconds","hours","Math","floor","toString","padStart","minutes","seconds","concat","authorshipStatus","firstFile","score","score_setting","icon","color","parseFloat"],"mappings":"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"}